<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>अनुप्रिता बी सोसायटी — सूचना नोंदणी</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap');

    :root {
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8F9FB;
      --bg-tertiary: #F0F1F5;
      --text-primary: #1A1A2E;
      --text-secondary: #6B7280;
      --text-muted: #9CA3AF;
      --border: #E5E7EB;
      --border-light: #F3F4F6;
      --accent: #6366F1;
      --accent-hover: #4F46E5;
      --success: #10B981;
      --warning: #F59E0B;
      --critical: #EF4444;
      --info: #3B82F6;
      --builder: #8B5CF6;
      --society: #0EA5E9;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 100px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', 'Noto Sans Devanagari', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* ============ Top Accent Bar ============ */
    body::before {
      content: '';
      display: block;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, var(--accent), var(--builder), var(--society));
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
    }

    /* ============ Animations ============ */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes progressBar {
      0% { width: 5%; }
      30% { width: 40%; }
      60% { width: 65%; }
      90% { width: 85%; }
      100% { width: 95%; }
    }
    @keyframes scalePop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes countUp {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pageFadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    .fade-in-up { animation: fadeInUp 0.4s ease-out both; }

    /* ============ Header ============ */
    .header {
      background: var(--bg-primary);
      padding: 12px 16px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      margin-top: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .header-content { flex: 1; }
    .header h1 {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.01em;
      margin-bottom: 0;
    }
    .header p {
      font-size: 0.72rem;
      font-weight: 400;
      color: var(--text-secondary);
    }

    /* ============ Page Containers ============ */
    .page { display: none; min-height: calc(100vh - 56px); }
    .page.active { display: block; animation: pageFadeIn 0.25s ease-out; }

    /* ============ Bottom Nav ============ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      padding-bottom: env(safe-area-inset-bottom, 0px);
      background: var(--bg-primary);
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 1000;
      box-shadow: 0 -1px 4px rgba(0,0,0,0.04);
    }
    .nav-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      background: none;
      border: none;
      font-family: inherit;
      font-size: 0.68rem;
      color: var(--text-muted);
      cursor: pointer;
      position: relative;
      -webkit-tap-highlight-color: transparent;
      transition: color 0.15s ease;
    }
    .nav-tab.active { color: var(--accent); font-weight: 600; }
    .nav-tab.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 25%;
      right: 25%;
      height: 2px;
      background: var(--accent);
      border-radius: 0 0 2px 2px;
    }
    .nav-tab svg { width: 22px; height: 22px; }

    /* ============ Container ============ */
    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px 14px calc(56px + 16px + env(safe-area-inset-bottom, 0px));
    }

    /* ============ Page Title (Submit page) ============ */
    .page-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .page-title-icon {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--warning);
      flex-shrink: 0;
    }

    /* ============ MC Login Button ============ */
    .mc-login-btn {
      padding: 5px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-primary);
      color: var(--text-muted);
      font-size: 0.68rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .mc-login-btn:hover { border-color: var(--accent); color: var(--accent); }
    .mc-login-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* ============ Stats Bar ============ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 12px;
      animation: fadeInUp 0.4s ease-out 0.05s both;
    }
    .stat-card {
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      padding: 12px 8px;
      text-align: center;
      border: 1px solid var(--border);
      transition: transform 0.15s ease;
    }
    .stat-card:active { transform: scale(0.97); }
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1.1;
      animation: countUp 0.3s ease-out both;
    }
    .stat-label {
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .stat-total .stat-number { color: var(--text-primary); }
    .stat-builder .stat-number { color: var(--builder); }
    .stat-society .stat-number { color: var(--society); }
    .stat-resolved .stat-number { color: var(--success); }

    @media (max-width: 380px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* ============ Section Cards ============ */
    .section-card {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 18px 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .section-title {
      font-size: 0.92rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-icon {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .icon-issues { background: var(--accent); }

    /* ============ Tab Switcher ============ */
    .tab-switcher {
      display: flex;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      padding: 3px;
      margin-bottom: 14px;
      position: relative;
    }
    .tab-btn {
      flex: 1;
      padding: 7px 16px;
      border: none;
      border-radius: var(--radius-full);
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.78rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      z-index: 1;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active {
      background: var(--bg-primary);
      color: var(--text-primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      font-weight: 600;
    }

    /* ============ Filter Pills ============ */
    .filters {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 4px;
      margin-bottom: 14px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .filters::-webkit-scrollbar { display: none; }

    .filter-pill {
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-size: 0.75rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 5px;
      -webkit-tap-highlight-color: transparent;
    }
    .filter-pill:hover { border-color: var(--accent); color: var(--accent); }
    .filter-pill:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .filter-pill.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .filter-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px; height: 18px;
      border-radius: 9px;
      font-size: 0.65rem;
      font-weight: 600;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      padding: 0 5px;
    }
    .filter-pill.active .filter-count {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    /* ============ Skeleton Loading (Table) ============ */
    .skeleton-table {
      width: 100%;
      border-collapse: collapse;
    }
    .skeleton-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-light);
    }
    .skeleton-line {
      height: 12px;
      border-radius: 6px;
      background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--border-light) 50%, var(--bg-tertiary) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }
    .skeleton-line-short { width: 30px; }
    .skeleton-line-medium { width: 70%; }
    .skeleton-line-long { width: 90%; }
    .skeleton-badge-sm {
      display: inline-block;
      width: 50px; height: 20px;
      border-radius: var(--radius-full);
      background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--border-light) 50%, var(--bg-tertiary) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
    }

    /* ============ Table View ============ */
    .issues-table-wrap {
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .issues-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    .issues-table thead th {
      background: var(--bg-tertiary);
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.72rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }
    .issues-table tbody tr {
      transition: background 0.12s ease;
    }
    .issues-table tbody tr:nth-child(even) {
      background: var(--bg-secondary);
    }
    .issues-table tbody tr:hover {
      background: #EEF2FF;
    }
    .issues-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }
    .issues-table .col-num {
      width: 36px;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.72rem;
    }
    .issues-table .col-issue {
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.35;
    }
    .issues-table .col-cat { width: 70px; }
    .issues-table .col-status { width: 72px; }
    .issues-table .col-count {
      width: 42px;
      text-align: center;
    }
    .count-circle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px; height: 24px;
      border-radius: 12px;
      background: var(--accent);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0 6px;
    }

    @media (max-width: 420px) {
      .issues-table .col-cat,
      .issues-table thead th:nth-child(3) { display: none; }
    }

    /* ============ Badges ============ */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 0.68rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .badge-builder { background: #F5F3FF; color: #6D28D9; }
    .badge-society { background: #F0F9FF; color: #0369A1; }
    .badge-new { background: #EFF6FF; color: #1D4ED8; }
    .badge-progress { background: #FFFBEB; color: #B45309; }
    .badge-resolved { background: #F0FDF4; color: #15803D; }

    /* ============ Kanban Board ============ */
    .kanban-board { display: none; }
    .kanban-board.active { display: block; }

    .swim-lane {
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .swim-lane-header {
      background: var(--bg-tertiary);
      padding: 10px 14px;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .swim-lane-header .lane-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
    }
    .lane-dot-builder { background: var(--builder); }
    .lane-dot-society { background: var(--society); }
    .swim-lane-body {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      min-height: 100px;
    }
    .kanban-column {
      padding: 8px;
      border-right: 1px solid var(--border-light);
      min-height: 80px;
    }
    .kanban-column:last-child { border-right: none; }
    .kanban-col-header {
      font-size: 0.68rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 4px 6px 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .kanban-col-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 16px; height: 16px;
      border-radius: 8px;
      background: var(--bg-tertiary);
      font-size: 0.6rem;
      font-weight: 700;
      color: var(--text-muted);
      padding: 0 4px;
    }

    .kanban-card {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      margin-bottom: 6px;
      font-size: 0.72rem;
      cursor: default;
      transition: box-shadow 0.15s ease, transform 0.15s ease;
    }
    .kanban-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .kanban-card.draggable {
      cursor: grab;
    }
    .kanban-card.draggable:active {
      cursor: grabbing;
    }
    .kanban-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    .kanban-column.drag-over {
      background: #EEF2FF;
    }
    .kanban-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }
    .kanban-card-num {
      font-size: 0.62rem;
      font-weight: 600;
      color: var(--text-muted);
    }
    .kanban-card-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px; height: 18px;
      border-radius: 9px;
      background: var(--accent);
      color: white;
      font-size: 0.6rem;
      font-weight: 600;
      padding: 0 4px;
      flex-shrink: 0;
    }
    .kanban-card-title {
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .kanban-card-flats {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
      margin-top: 5px;
    }
    .kanban-flat-chip {
      display: inline-block;
      padding: 0px 5px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-size: 0.6rem;
      font-weight: 500;
      color: var(--text-muted);
    }

    @media (max-width: 640px) {
      .swim-lane-body {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      .swim-lane-body::-webkit-scrollbar { display: none; }
      .kanban-column {
        min-width: 160px;
      }
    }

    /* ============ Empty / Error state ============ */
    .empty-state {
      text-align: center;
      padding: 36px 20px;
      animation: fadeIn 0.4s ease-out;
    }
    .empty-icon-svg {
      width: 40px; height: 40px;
      margin: 0 auto 12px;
      color: var(--text-muted);
      opacity: 0.5;
    }
    .empty-title {
      font-size: 0.88rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .empty-sub {
      font-size: 0.78rem;
      color: var(--text-muted);
    }
    .retry-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
      padding: 8px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      font-size: 0.78rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .retry-btn:hover { background: var(--accent-hover); }
    .retry-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    /* Flat chips in table row tooltip */
    .issue-flats-inline {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }
    .flat-chip {
      display: inline-block;
      padding: 1px 7px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 0.68rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* ============ Form ============ */
    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block;
      font-size: 0.78rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }
    .form-label .required { color: var(--critical); font-weight: 600; }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      -webkit-appearance: none;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    .form-input:focus-visible {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    .form-input::placeholder { color: var(--text-muted); }
    textarea.form-input {
      min-height: 100px;
      resize: vertical;
      line-height: 1.5;
    }

    .form-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 5px;
      line-height: 1.5;
    }

    /* Photo upload */
    .photo-upload-area {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .photo-btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 9px 16px;
      border: 1px dashed var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: border-color 0.15s ease, color 0.15s ease;
    }
    .photo-btn:hover { border-color: var(--accent); color: var(--accent); }
    .photo-btn-icon {
      width: 16px; height: 16px;
    }
    .photo-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .photo-thumb-wrap {
      position: relative;
      width: 52px; height: 52px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 1px solid var(--border);
      animation: scalePop 0.25s ease-out;
    }
    .photo-thumb-wrap img {
      width: 100%; height: 100%;
      object-fit: cover;
    }
    .photo-remove-btn {
      position: absolute;
      top: -1px; right: -1px;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--critical);
      color: white;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid white;
      line-height: 1;
    }

    /* Submit button */
    .submit-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: opacity 0.15s ease, transform 0.08s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .submit-btn:hover { opacity: 0.92; }
    .submit-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .submit-btn:active { transform: scale(0.99); }
    .submit-btn:disabled {
      background: #D1D5DB;
      cursor: not-allowed;
      transform: none;
    }

    /* ============ Processing Overlay ============ */
    .ai-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .ai-overlay.show { display: flex; }

    .ai-box {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 32px 28px;
      text-align: center;
      max-width: 320px;
      width: 100%;
      border: 1px solid var(--border);
      animation: scalePop 0.3s ease-out;
    }
    .ai-spinner {
      width: 40px; height: 40px;
      margin: 0 auto 16px;
      border: 3px solid var(--bg-tertiary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .ai-title {
      font-size: 0.92rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .ai-status {
      font-size: 0.78rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
      min-height: 1.5em;
    }
    .ai-progress {
      width: 100%;
      height: 3px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      overflow: hidden;
    }
    .ai-progress-bar {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      animation: progressBar 12s ease-out forwards;
    }

    /* ============ Success Confirmation ============ */
    .success-card {
      display: none;
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      overflow: hidden;
      animation: fadeInUp 0.4s ease-out;
    }
    .success-card.show { display: block; }
    .success-header {
      background: var(--success);
      color: white;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .success-check {
      width: 28px; height: 28px;
      flex-shrink: 0;
    }
    .success-title {
      font-size: 0.88rem;
      font-weight: 600;
    }
    .success-body { padding: 14px 16px; }
    .success-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 10px;
      font-weight: 500;
    }
    .result-item {
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      animation: fadeInUp 0.3s ease-out both;
    }
    .result-item:nth-child(2) { animation-delay: 0.08s; }
    .result-item:nth-child(3) { animation-delay: 0.16s; }
    .result-merged { background: #FFFBEB; border: 1px solid #FDE68A; }
    .result-created { background: #EFF6FF; border: 1px solid #BFDBFE; }
    .result-icon {
      width: 22px; height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .result-merged .result-icon { background: #FDE68A; color: #92400E; }
    .result-created .result-icon { background: #BFDBFE; color: #1E40AF; }
    .result-text {
      font-size: 0.78rem;
      line-height: 1.4;
      color: var(--text-primary);
    }
    .result-tag {
      font-size: 0.68rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .success-footer-actions {
      display: flex;
      border-top: 1px solid var(--border-light);
    }
    .success-action-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      font-size: 0.75rem;
      font-family: inherit;
      cursor: pointer;
      transition: color 0.15s ease, background 0.15s ease;
    }
    .success-action-btn:first-child {
      border-right: 1px solid var(--border-light);
    }
    .success-view-btn {
      color: var(--accent);
      font-weight: 500;
    }
    .success-view-btn:hover { background: #EEF2FF; }
    .success-close-btn {
      color: var(--text-muted);
    }
    .success-close-btn:hover { color: var(--text-secondary); background: var(--bg-secondary); }

    /* ============ MC PIN Modal ============ */
    .pin-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(3px);
      z-index: 3000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .pin-modal.show { display: flex; }
    .pin-box {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 28px 24px;
      text-align: center;
      max-width: 280px;
      width: 100%;
      border: 1px solid var(--border);
      animation: scalePop 0.25s ease-out;
    }
    .pin-box h3 {
      font-size: 0.92rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .pin-box p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    .pin-input {
      width: 140px;
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1.2rem;
      font-family: inherit;
      text-align: center;
      letter-spacing: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      -webkit-appearance: none;
    }
    .pin-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
    }
    .pin-error {
      color: var(--critical);
      font-size: 0.72rem;
      margin-top: 8px;
      min-height: 1.2em;
    }
    .pin-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      justify-content: center;
    }
    .pin-actions button {
      padding: 8px 20px;
      border-radius: var(--radius-sm);
      font-size: 0.78rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.15s ease;
    }
    .pin-cancel {
      background: var(--bg-primary);
      color: var(--text-secondary);
    }
    .pin-submit {
      background: var(--accent);
      color: white;
      border-color: var(--accent) !important;
    }

    /* ============ Footer ============ */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.68rem;
      color: var(--text-muted);
      line-height: 1.6;
    }
    .footer-tagline {
      font-size: 0.62rem;
      color: var(--text-muted);
      opacity: 0.6;
      margin-top: 2px;
    }

    /* ============ Scrollbar ============ */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 2px; }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>अनुप्रिता बी को. हौ. सो. लि.</h1>
      <p>सोसायटी सूचना / तक्रार नोंदणी</p>
    </div>
  </div>

  <!-- ============ PAGE: Submit ============ -->
  <div class="page" id="pageSubmit">
    <div class="container">

      <!-- Success Confirmation -->
      <div id="successCard" class="success-card">
        <div class="success-header">
          <svg class="success-check" viewBox="0 0 28 28" fill="none">
            <circle cx="14" cy="14" r="14" fill="rgba(255,255,255,0.2)"/>
            <path d="M9 14.5L12.5 18L19 11" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div class="success-title">तुमची सूचना यशस्वीरित्या नोंदवली</div>
        </div>
        <div class="success-body">
          <div class="success-subtitle">खालील तक्रारी ओळखल्या:</div>
          <div id="successDetails"></div>
        </div>
        <div class="success-footer-actions">
          <button class="success-action-btn success-view-btn" onclick="navigateTo('tracker')">तक्रार पहा &rarr;</button>
          <button class="success-action-btn success-close-btn" onclick="closeSuccess()">बंद करा</button>
        </div>
      </div>

      <div class="page-title">
        <div class="page-title-icon"></div>
        तक्रार / सूचना नोंदवा
      </div>

      <form id="complaintForm" onsubmit="handleSubmit(event)">
        <div class="form-group">
          <label class="form-label">सदनिका क्रमांक <span class="required">*</span></label>
          <select id="flat" class="form-input" required>
            <option value="">-- निवडा --</option>
            <option value="101">101</option><option value="102">102</option>
            <option value="201">201</option><option value="202">202</option>
            <option value="301">301</option><option value="302">302</option>
            <option value="401">401</option><option value="402">402</option>
            <option value="501">501</option><option value="502">502</option>
            <option value="601">601</option><option value="602">602</option>
            <option value="701">701</option><option value="702">702</option>
            <option value="801">801</option><option value="802">802</option>
            <option value="901">901</option><option value="902">902</option>
            <option value="1001">1001</option><option value="1002">1002</option>
            <option value="1101">1101</option><option value="1102">1102</option>
            <option value="1201">1201</option><option value="1202">1202</option>
            <option value="Shop 1">Shop 1</option><option value="Shop 2">Shop 2</option>
            <option value="Office">Office</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">नाव <span class="required">*</span></label>
          <input type="text" id="name" class="form-input" required placeholder="तुमचे नाव">
        </div>

        <div class="form-group">
          <label class="form-label">फोन नंबर <span class="required">*</span></label>
          <input type="tel" id="phone" class="form-input" required placeholder="98XXXXXXXX" pattern="[0-9]{10}" maxlength="10">
        </div>

        <div class="form-group">
          <label class="form-label">तुमची सूचना / तक्रार <span class="required">*</span></label>
          <textarea id="description" class="form-input" required
            placeholder="तुमची तक्रार किंवा सूचना इथे लिहा. English किंवा मराठी — दोन्ही चालेल. एका वेळी अनेक तक्रारी लिहू शकता."></textarea>
          <div class="form-hint">अनेक तक्रारी स्वयंचलितपणे वेगळ्या केल्या जातील आणि मागील तक्रारींशी जोडल्या जातील</div>
        </div>

        <div class="form-group">
          <label class="form-label">फोटो (ऐच्छिक — जास्तीत जास्त 5)</label>
          <div class="photo-upload-area">
            <label class="photo-btn" for="photoInput">
              <svg class="photo-btn-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="1" y="3" width="14" height="10" rx="2"/>
                <circle cx="5.5" cy="7" r="1.5"/>
                <path d="M15 11l-3.5-3.5L6 13"/>
              </svg>
              फोटो निवडा
            </label>
            <input type="file" id="photoInput" accept="image/*" multiple
              style="display:none" onchange="handlePhotos(this)">
          </div>
          <div class="photo-preview" id="photoPreview"></div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">सबमिट करा</button>
      </form>

      <div class="footer">
        <div>अनुप्रिता बी को. हौ. सो. लि.</div>
        <div class="footer-tagline">AI-सहाय्यित तक्रार व्यवस्थापन &middot; <span class="footer-year"></span></div>
      </div>
    </div>
  </div>

  <!-- ============ PAGE: Tracker ============ -->
  <div class="page" id="pageTracker">
    <div class="container">

      <!-- Stats Grid -->
      <div id="statsGrid" class="stats-grid"></div>

      <!-- Issues Section -->
      <div class="section-card fade-in-up" style="animation-delay: 0.1s">
        <div class="section-header">
          <div class="section-title">
            <div class="section-icon icon-issues"></div>
            सद्यस्थिती
          </div>
          <button class="mc-login-btn" id="mcLoginBtn" onclick="handleMcLogin()">MC लॉगिन</button>
        </div>

        <!-- Tab Switcher -->
        <div class="tab-switcher">
          <button class="tab-btn active" onclick="switchTab('table', this)">सूची</button>
          <button class="tab-btn" onclick="switchTab('kanban', this)">बोर्ड</button>
        </div>

        <!-- Filters -->
        <div class="filters" id="filterBar"></div>

        <!-- Table View (default) -->
        <div id="tableView">
          <div id="issuesList">
            <table class="skeleton-table">
              <tr><td><div class="skeleton-line skeleton-line-short"></div></td><td><div class="skeleton-line skeleton-line-long"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-line skeleton-line-short"></div></td></tr>
              <tr><td><div class="skeleton-line skeleton-line-short"></div></td><td><div class="skeleton-line skeleton-line-medium"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-line skeleton-line-short"></div></td></tr>
              <tr><td><div class="skeleton-line skeleton-line-short"></div></td><td><div class="skeleton-line skeleton-line-long"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-line skeleton-line-short"></div></td></tr>
              <tr><td><div class="skeleton-line skeleton-line-short"></div></td><td><div class="skeleton-line skeleton-line-medium"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-line skeleton-line-short"></div></td></tr>
              <tr><td><div class="skeleton-line skeleton-line-short"></div></td><td><div class="skeleton-line skeleton-line-long"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-line skeleton-line-short"></div></td></tr>
            </table>
          </div>
        </div>

        <!-- Kanban View -->
        <div id="kanbanView" class="kanban-board"></div>
      </div>

      <div class="footer">
        <div>अनुप्रिता बी को. हौ. सो. लि.</div>
        <div class="footer-tagline">AI-सहाय्यित तक्रार व्यवस्थापन &middot; <span class="footer-year"></span></div>
      </div>
    </div>
  </div>

  <!-- ============ Bottom Navigation ============ -->
  <nav class="bottom-nav">
    <button class="nav-tab" data-page="submit" onclick="navigateTo('submit')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 20h9"/>
        <path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
      </svg>
      <span>तक्रार नोंदणी</span>
    </button>
    <button class="nav-tab" data-page="tracker" onclick="navigateTo('tracker')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 20V10"/>
        <path d="M12 20V4"/>
        <path d="M6 20v-6"/>
      </svg>
      <span>सद्यस्थिती</span>
    </button>
  </nav>

  <!-- Processing Overlay -->
  <div class="ai-overlay" id="aiOverlay">
    <div class="ai-box">
      <div class="ai-spinner"></div>
      <div class="ai-title">तक्रार प्रक्रिया सुरू आहे</div>
      <div class="ai-status" id="aiStatus">तक्रार विश्लेषण सुरू...</div>
      <div class="ai-progress">
        <div class="ai-progress-bar" id="aiProgressBar"></div>
      </div>
    </div>
  </div>

  <!-- MC PIN Modal -->
  <div class="pin-modal" id="pinModal">
    <div class="pin-box">
      <h3>MC लॉगिन</h3>
      <p>4-अंकी PIN टाका</p>
      <input type="password" class="pin-input" id="pinInput" maxlength="4" pattern="[0-9]{4}" inputmode="numeric">
      <div class="pin-error" id="pinError"></div>
      <div class="pin-actions">
        <button class="pin-cancel" onclick="closePinModal()">रद्द करा</button>
        <button class="pin-submit" onclick="submitPin()">लॉगिन</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // Apps Script API URL
    // ============================================================
    var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKE2nB5BRQv_lnNsDc2-ZVcEc9OaOVf4icp6vHv9kA5lUZBVnckG109u9ejb4MKg7a/exec';

    // ============================================================
    // State
    // ============================================================
    var allIssues = [];
    var currentFilter = 'all';
    var currentTab = 'table';
    var selectedPhotos = [];
    var loadTimeout = null;
    var isMcAuthenticated = false;
    var currentPage = 'submit';
    var trackerDataLoaded = false;

    var statusMessages = [
      'तक्रार विश्लेषण सुरू...',
      'मराठी मजकूर वाचत आहे...',
      'वेगवेगळ्या तक्रारी ओळखत आहे...',
      'प्राधान्यक्रम ठरवत आहे...',
      'मागील तक्रारींशी जुळवत आहे...',
      'नोंदणी अद्ययावत करत आहे...'
    ];

    // ============================================================
    // Router
    // ============================================================
    function navigateTo(page) {
      if (page === currentPage) return;
      document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
      document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelector('.nav-tab[data-page="' + page + '"]').classList.add('active');
      document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
      history.replaceState(null, '', '#' + page);
      currentPage = page;
      if (page === 'tracker' && !trackerDataLoaded) {
        loadIssues();
        trackerDataLoaded = true;
      }
      window.scrollTo(0, 0);
    }

    function initRouter() {
      var hash = location.hash.replace('#', '');
      var page = (hash === 'tracker') ? 'tracker' : 'submit';
      document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
      document.querySelector('.nav-tab[data-page="' + page + '"]').classList.add('active');
      currentPage = page;
      if (page === 'tracker') {
        loadIssues();
        trackerDataLoaded = true;
      }
    }

    window.addEventListener('hashchange', function() {
      var page = location.hash.replace('#', '') === 'tracker' ? 'tracker' : 'submit';
      navigateTo(page);
    });

    // ============================================================
    // Load on DOMContentLoaded
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.footer-year').forEach(function(el) {
        el.textContent = new Date().getFullYear();
      });
      initRouter();
    });

    function loadIssues() {
      console.log('[Tracker] Loading issues via fetch...');

      document.getElementById('issuesList').innerHTML =
        '<table class="skeleton-table">' +
        '<tr><td><div class="skeleton-line skeleton-line-short"></div></td><td><div class="skeleton-line skeleton-line-long"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-badge-sm"></div></td><td><div class="skeleton-line skeleton-line-short"></div></td></tr>'.repeat(5) +
        '</table>';

      loadTimeout = setTimeout(function() {
        console.log('[Tracker] Load timeout after 15 seconds');
        showLoadError('तक्रारी लोड होण्यास वेळ लागत आहे');
      }, 15000);

      fetch(SCRIPT_URL + '?action=getIssues')
        .then(function(r) { return r.text(); })
        .then(function(text) {
          clearTimeout(loadTimeout);
          try {
            var data = JSON.parse(text);
            if (data.success) {
              console.log('[Tracker] Issues loaded:', data.issues ? data.issues.length : 0);
              allIssues = data.issues || [];
              renderStats();
              renderFilters();
              renderIssues();
              renderKanban();
            } else {
              console.error('[Tracker] API error:', data.error);
              showLoadError('तक्रारी लोड करता आल्या नाहीत');
            }
          } catch (parseErr) {
            console.error('[Tracker] JSON parse error:', parseErr, 'Raw:', text.substring(0, 200));
            showLoadError('तक्रारी लोड करता आल्या नाहीत');
          }
        })
        .catch(function(err) {
          clearTimeout(loadTimeout);
          console.error('[Tracker] Fetch failed:', err);
          showLoadError('नेटवर्क कनेक्शन तपासा');
        });
    }

    function showLoadError(message) {
      document.getElementById('issuesList').innerHTML =
        '<div class="empty-state">' +
          '<svg class="empty-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">' +
            '<circle cx="12" cy="12" r="10"/>' +
            '<line x1="12" y1="8" x2="12" y2="12"/>' +
            '<line x1="12" y1="16" x2="12.01" y2="16"/>' +
          '</svg>' +
          '<div class="empty-title">' + message + '</div>' +
          '<div class="empty-sub">कृपया पुन्हा प्रयत्न करा</div>' +
          '<button class="retry-btn" onclick="loadIssues()">' +
            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/></svg>' +
            'पुन्हा प्रयत्न करा' +
          '</button>' +
        '</div>';
    }

    // ============================================================
    // Tab Switching
    // ============================================================
    function switchTab(tab, btn) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');

      if (tab === 'table') {
        document.getElementById('tableView').style.display = 'block';
        document.getElementById('kanbanView').classList.remove('active');
      } else {
        document.getElementById('tableView').style.display = 'none';
        document.getElementById('kanbanView').classList.add('active');
        renderKanban();
      }
    }

    // ============================================================
    // Render Stats (with count-up animation)
    // ============================================================
    function renderStats() {
      var total = allIssues.length;
      var builder = allIssues.filter(function(i) { return i.category === 'बिल्डर'; }).length;
      var society = allIssues.filter(function(i) { return i.category === 'सोसायटी'; }).length;
      var resolved = allIssues.filter(function(i) { return i.status === 'निराकरण'; }).length;

      var stats = [
        { cls: 'stat-total', value: total, label: 'एकूण तक्रारी' },
        { cls: 'stat-builder', value: builder, label: 'बिल्डर' },
        { cls: 'stat-society', value: society, label: 'सोसायटी' },
        { cls: 'stat-resolved', value: resolved, label: 'निराकरण' }
      ];

      document.getElementById('statsGrid').innerHTML = stats.map(function(s) {
        return '<div class="stat-card ' + s.cls + '">' +
          '<div class="stat-number" data-target="' + s.value + '">0</div>' +
          '<div class="stat-label">' + s.label + '</div>' +
        '</div>';
      }).join('');

      // Animate numbers
      document.querySelectorAll('.stat-number[data-target]').forEach(function(el) {
        var target = parseInt(el.getAttribute('data-target'));
        if (target === 0) { el.textContent = '0'; return; }
        var start = 0;
        var duration = 300;
        var startTime = null;
        function step(ts) {
          if (!startTime) startTime = ts;
          var progress = Math.min((ts - startTime) / duration, 1);
          el.textContent = Math.floor(progress * target);
          if (progress < 1) requestAnimationFrame(step);
          else el.textContent = target;
        }
        requestAnimationFrame(step);
      });
    }

    // ============================================================
    // Render Filters (no priority/तातडी filter)
    // ============================================================
    function renderFilters() {
      var counts = {
        all: allIssues.length,
        builder: allIssues.filter(function(i) { return i.category === 'बिल्डर'; }).length,
        society: allIssues.filter(function(i) { return i.category === 'सोसायटी'; }).length,
        progress: allIssues.filter(function(i) { return i.status === 'प्रगतीत'; }).length,
        resolved: allIssues.filter(function(i) { return i.status === 'निराकरण'; }).length
      };

      var filters = [
        { key: 'all', label: 'सर्व' },
        { key: 'builder', label: 'बिल्डर' },
        { key: 'society', label: 'सोसायटी' },
        { key: 'progress', label: 'प्रगतीत' },
        { key: 'resolved', label: 'निराकरण' }
      ];

      document.getElementById('filterBar').innerHTML = filters.map(function(f) {
        var active = currentFilter === f.key ? ' active' : '';
        var countHtml = counts[f.key] > 0
          ? ' <span class="filter-count">' + counts[f.key] + '</span>'
          : '';
        return '<button class="filter-pill' + active + '" onclick="applyFilter(\'' + f.key + '\', this)">' +
          f.label + countHtml + '</button>';
      }).join('');
    }

    // ============================================================
    // Render Table View
    // ============================================================
    function renderIssues() {
      try {
        var filtered = filterIssues(allIssues, currentFilter);
        var list = document.getElementById('issuesList');
        console.log('[Tracker] Rendering', filtered.length, 'issues in table');

        if (filtered.length === 0) {
          list.innerHTML =
            '<div class="empty-state">' +
              '<svg class="empty-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">' +
                '<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>' +
                '<polyline points="14 2 14 8 20 8"/>' +
                '<line x1="16" y1="13" x2="8" y2="13"/>' +
                '<line x1="16" y1="17" x2="8" y2="17"/>' +
              '</svg>' +
              '<div class="empty-title">या प्रकारच्या तक्रारी सापडल्या नाहीत</div>' +
              '<div class="empty-sub">नवीन तक्रार नोंदवण्यासाठी तक्रार नोंदणी पेज वापरा</div>' +
            '</div>';
          return;
        }

        var html = '<div class="issues-table-wrap"><table class="issues-table">' +
          '<thead><tr>' +
            '<th>#</th>' +
            '<th>तक्रार</th>' +
            '<th>प्रकार</th>' +
            '<th>स्थिती</th>' +
            '<th>तक्रारी</th>' +
          '</tr></thead><tbody>';

        html += filtered.map(function(issue) {
          return '<tr>' +
            '<td class="col-num">' + issue.issueNo + '</td>' +
            '<td class="col-issue">' + escapeHtml(issue.issue) + '</td>' +
            '<td class="col-cat">' + getCategoryBadge(issue.category) + '</td>' +
            '<td class="col-status">' + getStatusBadge(issue.status) + '</td>' +
            '<td class="col-count"><span class="count-circle">' + (issue.count || 0) + '</span></td>' +
          '</tr>';
        }).join('');

        html += '</tbody></table></div>';
        list.innerHTML = html;
        console.log('[Tracker] Table render complete');
      } catch(e) {
        console.error('[Tracker] Render error:', e.message, e.stack);
        showLoadError('तक्रारी दाखवता आल्या नाहीत: ' + e.message);
      }
    }

    // ============================================================
    // Render Kanban Board
    // ============================================================
    function renderKanban() {
      var filtered = filterIssues(allIssues, currentFilter);
      var kanbanEl = document.getElementById('kanbanView');

      var categories = ['बिल्डर', 'सोसायटी'];
      var statuses = ['नवीन', 'प्रगतीत', 'निराकरण'];
      var dotClasses = { 'बिल्डर': 'lane-dot-builder', 'सोसायटी': 'lane-dot-society' };

      var html = '';

      categories.forEach(function(cat) {
        var catIssues = filtered.filter(function(i) { return i.category === cat; });

        html += '<div class="swim-lane">';
        html += '<div class="swim-lane-header"><span class="lane-dot ' + dotClasses[cat] + '"></span>' + cat + '</div>';
        html += '<div class="swim-lane-body">';

        statuses.forEach(function(status) {
          var colIssues = catIssues.filter(function(i) { return i.status === status; });
          var colId = 'col-' + cat + '-' + status;

          html += '<div class="kanban-column" id="' + colId + '" data-category="' + cat + '" data-status="' + status + '"' +
            (isMcAuthenticated ? ' ondragover="kanbanDragOver(event)" ondrop="kanbanDrop(event)" ondragleave="kanbanDragLeave(event)"' : '') + '>';
          html += '<div class="kanban-col-header">' + status +
            ' <span class="kanban-col-count">' + colIssues.length + '</span></div>';

          colIssues.forEach(function(issue) {
            var rb = issue.reportedBy ? String(issue.reportedBy) : '';
            var flats = rb ? rb.split(',').map(function(f) { return f.trim(); }) : [];
            var flatChips = flats.slice(0, 3).map(function(f) {
              return '<span class="kanban-flat-chip">' + escapeHtml(f) + '</span>';
            }).join('');
            if (flats.length > 3) flatChips += '<span class="kanban-flat-chip">+' + (flats.length - 3) + '</span>';

            var draggable = isMcAuthenticated ? ' draggable="true" ondragstart="kanbanDragStart(event)"' : '';
            var draggableClass = isMcAuthenticated ? ' draggable' : '';

            html += '<div class="kanban-card' + draggableClass + '" data-issue-no="' + issue.issueNo + '" data-category="' + cat + '"' + draggable + '>' +
              '<div class="kanban-card-header">' +
                '<span class="kanban-card-num">#' + issue.issueNo + '</span>' +
                '<span class="kanban-card-count">' + (issue.count || 0) + '</span>' +
              '</div>' +
              '<div class="kanban-card-title">' + escapeHtml(issue.issue) + '</div>' +
              (flatChips ? '<div class="kanban-card-flats">' + flatChips + '</div>' : '') +
            '</div>';
          });

          html += '</div>';
        });

        html += '</div></div>';
      });

      kanbanEl.innerHTML = html;
    }

    // ============================================================
    // Kanban Drag & Drop (MC only)
    // ============================================================
    var draggedIssueNo = null;
    var draggedCategory = null;

    function kanbanDragStart(e) {
      draggedIssueNo = e.target.getAttribute('data-issue-no');
      draggedCategory = e.target.getAttribute('data-category');
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedIssueNo);
    }

    function kanbanDragOver(e) {
      e.preventDefault();
      var col = e.currentTarget;
      if (col.getAttribute('data-category') === draggedCategory) {
        col.classList.add('drag-over');
        e.dataTransfer.dropEffect = 'move';
      }
    }

    function kanbanDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function kanbanDrop(e) {
      e.preventDefault();
      var col = e.currentTarget;
      col.classList.remove('drag-over');

      var targetCategory = col.getAttribute('data-category');
      var targetStatus = col.getAttribute('data-status');

      if (targetCategory !== draggedCategory) return;

      // Remove dragging class
      document.querySelectorAll('.kanban-card.dragging').forEach(function(el) {
        el.classList.remove('dragging');
      });

      // Update status via API
      updateIssueStatus(draggedIssueNo, targetStatus);
    }

    function updateIssueStatus(issueNo, newStatus) {
      // Optimistic update
      allIssues.forEach(function(issue) {
        if (issue.issueNo == issueNo) {
          issue.status = newStatus;
        }
      });
      renderKanban();
      renderStats();
      renderFilters();
      if (currentTab === 'table') renderIssues();

      fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action: 'updateStatus', issueNo: issueNo, newStatus: newStatus })
      })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.success) {
            console.error('[Tracker] Status update failed:', data.error);
            loadIssues(); // Reload to revert
          }
        })
        .catch(function(err) {
          console.error('[Tracker] Status update fetch failed:', err);
          loadIssues();
        });
    }

    // ============================================================
    // Touch drag support for mobile Kanban
    // ============================================================
    (function() {
      var touchCard = null;
      var touchClone = null;
      var touchStartX, touchStartY;

      document.addEventListener('touchstart', function(e) {
        var card = e.target.closest('.kanban-card.draggable');
        if (!card) return;
        touchCard = card;
        draggedIssueNo = card.getAttribute('data-issue-no');
        draggedCategory = card.getAttribute('data-category');
        var touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
      }, { passive: true });

      document.addEventListener('touchmove', function(e) {
        if (!touchCard) return;
        var touch = e.touches[0];
        var dx = Math.abs(touch.clientX - touchStartX);
        var dy = Math.abs(touch.clientY - touchStartY);
        if (dx > 10 || dy > 10) {
          e.preventDefault();
          if (!touchClone) {
            touchClone = touchCard.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.zIndex = '9999';
            touchClone.style.width = touchCard.offsetWidth + 'px';
            touchClone.style.opacity = '0.85';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.transform = 'rotate(2deg)';
            document.body.appendChild(touchClone);
            touchCard.style.opacity = '0.3';
          }
          touchClone.style.left = (touch.clientX - touchCard.offsetWidth / 2) + 'px';
          touchClone.style.top = (touch.clientY - 20) + 'px';

          // Highlight target column
          document.querySelectorAll('.kanban-column.drag-over').forEach(function(c) { c.classList.remove('drag-over'); });
          var target = document.elementFromPoint(touch.clientX, touch.clientY);
          if (target) {
            var col = target.closest('.kanban-column');
            if (col && col.getAttribute('data-category') === draggedCategory) {
              col.classList.add('drag-over');
            }
          }
        }
      }, { passive: false });

      document.addEventListener('touchend', function(e) {
        if (!touchCard || !touchClone) {
          touchCard = null;
          return;
        }

        var touch = e.changedTouches[0];
        var target = document.elementFromPoint(touch.clientX, touch.clientY);
        if (target) {
          var col = target.closest('.kanban-column');
          if (col && col.getAttribute('data-category') === draggedCategory) {
            var newStatus = col.getAttribute('data-status');
            updateIssueStatus(draggedIssueNo, newStatus);
          }
        }

        document.querySelectorAll('.kanban-column.drag-over').forEach(function(c) { c.classList.remove('drag-over'); });
        touchCard.style.opacity = '';
        if (touchClone && touchClone.parentNode) touchClone.parentNode.removeChild(touchClone);
        touchCard = null;
        touchClone = null;
      }, { passive: true });
    })();

    // ============================================================
    // Filter Logic (no priority filter)
    // ============================================================
    function filterIssues(issues, filter) {
      switch(filter) {
        case 'builder': return issues.filter(function(i) { return i.category === 'बिल्डर'; });
        case 'society': return issues.filter(function(i) { return i.category === 'सोसायटी'; });
        case 'progress': return issues.filter(function(i) { return i.status === 'प्रगतीत'; });
        case 'resolved': return issues.filter(function(i) { return i.status === 'निराकरण'; });
        default: return issues;
      }
    }

    function applyFilter(filter, btn) {
      currentFilter = filter;
      document.querySelectorAll('.filter-pill').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      renderIssues();
      if (currentTab === 'kanban') renderKanban();
    }

    // ============================================================
    // Badge Helpers (no priority badge)
    // ============================================================
    function getStatusBadge(s) {
      if (!s) return '';
      if (s === 'नवीन') return '<span class="badge badge-new">' + s + '</span>';
      if (s === 'प्रगतीत') return '<span class="badge badge-progress">' + s + '</span>';
      if (s === 'निराकरण') return '<span class="badge badge-resolved">' + s + '</span>';
      return '<span class="badge">' + escapeHtml(s) + '</span>';
    }

    function getCategoryBadge(c) {
      if (!c) return '';
      if (c === 'बिल्डर') return '<span class="badge badge-builder">' + c + '</span>';
      if (c === 'सोसायटी') return '<span class="badge badge-society">' + c + '</span>';
      return '<span class="badge">' + escapeHtml(c) + '</span>';
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      var div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // ============================================================
    // MC Login / PIN
    // ============================================================
    function handleMcLogin() {
      if (isMcAuthenticated) {
        isMcAuthenticated = false;
        document.getElementById('mcLoginBtn').classList.remove('active');
        document.getElementById('mcLoginBtn').textContent = 'MC लॉगिन';
        if (currentTab === 'kanban') renderKanban();
        return;
      }
      document.getElementById('pinModal').classList.add('show');
      document.getElementById('pinInput').value = '';
      document.getElementById('pinError').textContent = '';
      setTimeout(function() { document.getElementById('pinInput').focus(); }, 100);
    }

    function closePinModal() {
      document.getElementById('pinModal').classList.remove('show');
    }

    function submitPin() {
      var pin = document.getElementById('pinInput').value.trim();
      if (pin.length !== 4) {
        document.getElementById('pinError').textContent = '4 अंक टाका';
        return;
      }

      fetch(SCRIPT_URL + '?action=verifyPin&pin=' + encodeURIComponent(pin))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.valid) {
            isMcAuthenticated = true;
            document.getElementById('mcLoginBtn').classList.add('active');
            document.getElementById('mcLoginBtn').textContent = 'MC मोड';
            closePinModal();
            if (currentTab === 'kanban') renderKanban();
          } else {
            document.getElementById('pinError').textContent = 'चुकीचा PIN';
            document.getElementById('pinInput').value = '';
            document.getElementById('pinInput').focus();
          }
        })
        .catch(function(err) {
          document.getElementById('pinError').textContent = 'कनेक्शन त्रुटी';
          console.error('[Tracker] PIN verify failed:', err);
        });
    }

    // Allow Enter key in PIN input
    document.addEventListener('DOMContentLoaded', function() {
      var pinInput = document.getElementById('pinInput');
      if (pinInput) {
        pinInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') submitPin();
        });
      }
    });

    // ============================================================
    // Photo Handling
    // ============================================================
    function handlePhotos(input) {
      var files = Array.from(input.files);
      if (selectedPhotos.length + files.length > 5) {
        alert('जास्तीत जास्त 5 फोटो निवडता येतात.');
        return;
      }

      files.forEach(function(file) {
        if (selectedPhotos.length >= 5) return;
        var reader = new FileReader();
        reader.onload = function(e) {
          var base64 = e.target.result.split(',')[1];
          var ext = file.name.split('.').pop();
          selectedPhotos.push({
            data: base64,
            mimeType: file.type,
            extension: ext,
            preview: e.target.result
          });
          renderPhotoPreview();
        };
        reader.readAsDataURL(file);
      });
      input.value = '';
    }

    function renderPhotoPreview() {
      var container = document.getElementById('photoPreview');
      container.innerHTML = selectedPhotos.map(function(photo, idx) {
        return '<div class="photo-thumb-wrap">' +
          '<img src="' + photo.preview + '">' +
          '<div class="photo-remove-btn" onclick="removePhoto(' + idx + ')">&#215;</div>' +
        '</div>';
      }).join('');
    }

    function removePhoto(idx) {
      selectedPhotos.splice(idx, 1);
      renderPhotoPreview();
    }

    // ============================================================
    // Form Submit
    // ============================================================
    function handleSubmit(e) {
      e.preventDefault();

      var flat = document.getElementById('flat').value;
      var name = document.getElementById('name').value.trim();
      var phone = document.getElementById('phone').value.trim();
      var description = document.getElementById('description').value.trim();

      if (!flat || !name || !phone || !description) {
        alert('कृपया सर्व आवश्यक माहिती भरा.');
        return;
      }

      showProcessingOverlay();

      var formData = {
        flat: flat,
        name: name,
        phone: phone,
        description: description,
        photos: selectedPhotos.map(function(p) {
          return { data: p.data, mimeType: p.mimeType, extension: p.extension };
        })
      };

      fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(formData)
      })
        .then(function(r) { return r.text(); })
        .then(function(text) {
          hideProcessingOverlay();
          try {
            var result = JSON.parse(text);
            if (result.success) {
              showSuccess(result.results);
              resetForm();
            } else {
              alert('तक्रार नोंदवता आली नाही: ' + (result.error || 'Unknown error'));
            }
          } catch (parseErr) {
            console.error('[Tracker] Submit response parse error:', parseErr, 'Raw:', text.substring(0, 200));
            alert('तक्रार नोंदवता आली नाही. कृपया पुन्हा प्रयत्न करा.');
          }
        })
        .catch(function(err) {
          hideProcessingOverlay();
          console.error('[Tracker] Submit fetch failed:', err);
          alert('तक्रार नोंदवता आली नाही. नेटवर्क कनेक्शन तपासा.');
        });
    }

    // ============================================================
    // Processing Overlay
    // ============================================================
    var statusInterval = null;

    function showProcessingOverlay() {
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('aiProgressBar').style.animation = 'none';
      void document.getElementById('aiProgressBar').offsetWidth;
      document.getElementById('aiProgressBar').style.animation = 'progressBar 12s ease-out forwards';

      var overlay = document.getElementById('aiOverlay');
      overlay.classList.add('show');

      var idx = 0;
      document.getElementById('aiStatus').textContent = statusMessages[0];
      statusInterval = setInterval(function() {
        idx++;
        if (idx < statusMessages.length) {
          document.getElementById('aiStatus').textContent = statusMessages[idx];
        }
      }, 2200);
    }

    function hideProcessingOverlay() {
      document.getElementById('aiOverlay').classList.remove('show');
      document.getElementById('submitBtn').disabled = false;
      if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
      }
    }

    // ============================================================
    // Success Confirmation
    // ============================================================
    function showSuccess(results) {
      var details = document.getElementById('successDetails');
      details.innerHTML = results.map(function(r) {
        if (r.action === 'merged') {
          return '<div class="result-item result-merged">' +
            '<div class="result-icon">' +
              '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>' +
            '</div>' +
            '<div>' +
              '<div class="result-text">' + escapeHtml(r.issue) + '</div>' +
              '<div class="result-tag">Issue #' + r.issueNo + ' मध्ये जोडले (' + r.previousCount + ' → ' + r.newCount + ' तक्रारी)</div>' +
            '</div>' +
          '</div>';
        } else {
          return '<div class="result-item result-created">' +
            '<div class="result-icon">' +
              '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
            '</div>' +
            '<div>' +
              '<div class="result-text">' + escapeHtml(r.issue) + '</div>' +
              '<div class="result-tag">नवीन Issue #' + r.issueNo + ' तयार केले</div>' +
            '</div>' +
          '</div>';
        }
      }).join('');

      var card = document.getElementById('successCard');
      card.classList.add('show');
      card.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Don't auto-hide — let user choose to view tracker or close
    }

    function closeSuccess() {
      document.getElementById('successCard').classList.remove('show');
    }

    // ============================================================
    // Reset Form
    // ============================================================
    function resetForm() {
      document.getElementById('complaintForm').reset();
      selectedPhotos = [];
      renderPhotoPreview();
      trackerDataLoaded = false; // Force refresh on next tab switch
    }
  </script>

</body>
</html>
